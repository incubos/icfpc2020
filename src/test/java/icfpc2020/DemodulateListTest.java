package icfpc2020;

import icfpc2020.api.GameResponse;
import icfpc2020.eval.value.DemodulateValue;
import icfpc2020.list.MList;
import org.junit.Assert;
import org.junit.Test;

import java.io.IOException;
import java.util.List;
import java.util.stream.Collectors;

public class DemodulateListTest {

    private static String stringify(List<Pictogram> list) {
        return list.stream().map(Pictogram::toString).collect(Collectors.joining(" "));
    }

    @Test
    public void testModulateList_shouldProduceExpectedResult() {
        Assert.assertEquals("nil",
                            stringify(DemodulateList.dem(new MessageImpl("00"))));
        Assert.assertEquals("ap ap cons nil nil",
                            stringify(DemodulateList.dem(new MessageImpl("110000"))));
        Assert.assertEquals("ap ap cons 0 nil",
                            stringify(DemodulateList.dem(new MessageImpl("1101000"))));
        Assert.assertEquals("ap ap cons 1 2",
                            stringify(DemodulateList.dem(new MessageImpl("110110000101100010"))));
        Assert.assertEquals("ap ap cons 1 ap ap cons 2 nil",
                            stringify(DemodulateList.dem(new MessageImpl("1101100001110110001000"))));
        Assert.assertEquals("ap ap cons 1 ap ap cons ap ap cons 2 ap ap cons 3 nil ap ap cons 4 nil",
                            stringify(DemodulateList.dem(new MessageImpl("1101100001111101100010110110001100110110010000"))));
        Assert.assertEquals("ap ap cons 1 ap ap cons 0 nil",
                            stringify(DemodulateList.dem(new MessageImpl("11011000011101000"))));
        Assert.assertEquals("ap ap cons ap ap cons ap ap cons ap ap cons ap ap cons ap ap cons ap ap cons ap ap cons ap ap cons ap ap cons ap ap cons ap ap cons ap ap cons ap ap cons ap ap cons ap ap cons",
                            stringify(DemodulateList.dem(new MessageImpl("11111111111111111111111111111111"))));
        Assert.assertEquals("ap ap cons 1 ap ap cons 81744 nil",
                            stringify(DemodulateList.dem(new MessageImpl("110110000111011111100001001111110101000000"))));
        Assert.assertEquals("ap ap cons 1 ap ap cons 81740 nil",
                            stringify(DemodulateList.dem(new MessageImpl("110110000111011111100001001111110100110000"))));
    }

    @Test
    public void testMList() throws IOException {
        Assert.assertEquals("[1,2,nil,nil]",
                            DemodulateList.demMList(new MessageImpl("110110000111011000101100110000")).toString());
        Assert.assertEquals("[nil]",
                            DemodulateList.demMList(new MessageImpl("110000")).toString());
        Assert.assertEquals("[0]",
                            DemodulateList.demMList(new MessageImpl("1101000")).toString());
        Assert.assertEquals("[1,[2,3],4]",
                            DemodulateList.demMList(new MessageImpl("1101100001111101100010110110001100110110010000")).toString());
        Assert.assertEquals("[1,0,[256,0,[512,1,64],[16,128],[1,2,1,2]],nil]",
                            DemodulateList.demMList(new MessageImpl("110110000111010111101111000010000000011010111101111000100000000011011000011101110010000000011110111000010000110111010000000001111011000011101100010110110000111011000100000110000")).toString());
        Assert.assertEquals("[1,2,[256,0,[512,1,64],[16,128],[1,2,1,2]],nil]",
                            DemodulateList.demMList(new MessageImpl("11011000011101100010111101111000010000000011010111101111000100000000011011000011101110010000000011110111000010000110111010000000001111011000011101100010110110000111011000100000110000")).toString());
        Assert.assertEquals("[1,2,[256,1,[448,1,64],[16,128],nil],nil]",
                            DemodulateList.demMList(new MessageImpl("110110000111011000101111011110000100000000110110000111110111100001110000001101100001110111001000000001111011100001000011011101000000000110000110000")).toString());
        List<Object> mList = DemodulateValue.eval(
                "11011000011101100001111101111000010000000011010111101111000100000000011011000011101110010000000011110111000010000110111010000000001111011100001010011011100001010011011100001010011011100001010000001111011000011111011100001000011011101000000000111111110110000111010111101101100011100010111111110101010000111110111000010100110111000010100110111000010100110111000010100001101011011100100000011011000010011000011111101011011000011111101011011011000110000111110100001010111101011011000101101100001110110001000110110011111011100100000011011000010011111101011110110000101100001000000000000");
        GameResponse gameResponse = new GameResponse(mList);
        System.out.println(gameResponse.toString());
        List<Object> mList2 = DemodulateValue.eval(
                "1101100001110110000111110111100001000000001101011110111100010000000001101100001110111001000000001111011100001000011011101000000000111101110000101001101110000101001101110000101001101110000101000000111101100101111101110000100001101110100000000011111111011000011101011110110110001110001000011111010101001011111011100001010011011100001010011011100001010011011100001010000110101101110010000001101100001001100001111110101101100001111110110000100011011000100110111110100001011001001111010110110001011011000011101100010001101100011110111001000000110110000100110000000000");
        GameResponse gameResponse2 = new GameResponse(mList2);
        System.out.println(gameResponse2.toString());
        List<Object> mList3 = DemodulateValue.eval(
                "11011000011101100001111101111000010000000011010111101111000100000000011011000011101110010000000011110111000010000110111010000000001111011110000100101100110110000111011010101101100001000011110110001111110111000010000110111010000000001111111101100001110101111011100011000101110001001011111011000101010010111110111100001001010011101100001110110101011011000010011010110111001000000110110000100111111010111110100001011000010011110110001011111011000101110101100010111111011000011101011011001000000001111110101101100001111110110001011111011000101101111110100001011000101111010110110001011011000011101100010001101100101110111001000000110110000100110000000000");
        GameResponse gameResponse3 = new GameResponse(mList3);
        System.out.println(gameResponse3.toString());

    }

    @Test
    public void testRealResponsesAreParsable() throws IOException {
        List<String> serverResponses = List.of(
                "1101100001110110000111110111100001000000001101100001111101111000011100000011011000011101110010000000011110111000010000110111010000000001100001111010111101110000100001101110100000000011111111011000011101011111011000110000011100011000011110100101111011000011101100010110110000111011000100011010110111001000000110110000100110000111111010110110000111110111000110000101100011000011110100101111011110000100000000110111000010000110110100011011000010011010110111001000000110110000100110000000000",
                "1101100001110110000111110111100001000000001101100001111101111000011100000011011000011101110010000000011110111000010000110111010000000001100001111011000011111011100001000011011101000000000111111110110000111010111110110001011110111000101111111101100001101000011111011000011101100010110110000111011000100011010110111001000000110110000100110000111111010110110000111110111000101111101100011000011111010000101011110111011111111110111000010000110110100011011000010011010110111001000000110110000100111111010111101001100001000000000000",
                "110110000111011000011111011110000100000000110110000111110111100001110000001101100001110111001000000001111011100001000011011101000000000110000111101100010111101110000100001101110100000000011111111011000011101011111011000101101011100010110111110110001010100010111101100001110110001011011000011101100010001101011011100100000011011000010011000011111101011011000011111011100010110110110001011111111101000100110000111110111011111110110111000010000110110100011011000010011010110111001000000110110000100111111010111101100001010000000000000",
                "11011000011101100001111101111000010000000011011000011111011110000111000000110110000111011100100000000111101110000100001101110100000000011000011110110001111110111000010000110111010000000001111111101100001110101111101100010101001110001010101111011000111010001111110110000111011000101101100001110110001000110101101110010000001101100001001100001111110101101100001111101110001011001011000101110111110100001011000011111011101111110111011100001000011011010001101100001001101011011100100000011011000010011111101011111010000101100001000000000000",
                "110110000111011000011111011110000100000000110110000111110111100001110000001101100001110111001000000001111011100001000011011101000000000110000111101100100111101110000100001101110100000000011111111011000011101011111011000100110011100010011011110110010010100100111101100001110110001011011000011101100010001101011011100100000011011000010011000011111101011011000011111011100010110010110001011011111010011000011111011101111110011011100001000011011010001101100001001101011011100100000011011000010011111101011111010000101100001000000000000",
                "11011000011101100001111101111000010000000011011000011111011110000111000000110110000111011100100000000111101110000100001101110100000000011000011110110010111110111000010000110111010000000001111111101100001110101111101100010000101110001000011111011001011010010111110110000111011000101101100001110110001000110101101110010000001101100001001100001111110101101100001111101110001011011011000101100111101100001011000011111011101111101111011100001000011011010001101100001001101011011100100000011011000010011111101011111010000101100001000000000000",
                "110110000111011000011111011110000100000000110110000111110111100001110000001101100001110111001000000001111011100001000011011101000000000110000111101100110111101110000100001101110100000000011111111011000011101011111011000011011011100001101111110110011010100110111101100001110110001011011000011101100010001101011011100100000011011000010011000011111101011011000011111011100010111010110001011001111011000010101111011101111101011011100001000011011010001101100001001101011011100100000011011000010011111101011111010000101100001000000000000",
                "11011000011101100001111101111000010000000011011000011111011110000111000000110110000111011100100000000111101110000100001101110100000000011000011110110011111110111000010000110111010000000001111111101100001110101111101100001010001110000101001111011001111010011111110110000111011000101101100001110110001000110101101110010000001101100001001100001111110101101100001111101110001011111011000101101111101100001101000011111011101111100111011100001000011011010001101100001001101011011100100000011011000010011111101011111010000101100001000000000000",
                "11011000011101100010111101111000010000000011011000011111011110000111000000110110000111011100100000000111101110000100001101110100000000011000011110110100011110111000010000110111010000000001111111101100001110101111101011000110110011110110100010101000111101011010110101101000110101101110010000001101100001001100001111110101101100001111101110001100001011000101111111101100001101000101111011101111100011011100001000011011010001101100001001101011011100100000011011000010011111101011111010000101100001000000000000",
                "1101100001110110000111110111100001000000001101011110111100010000000001101100001110111001000000001111011100001000011011101000000000111101101010110110101011011010101101100001000011110110000111110111000010000110111010000000001111111101100001110101111011100001100001110001100001111101000010101111011010011101101010110110101011011000010011010110111001000000110110000100111111010111101100001101000010000001111110101101100001111110110000110101011000110000111110100001010111101011011000101101100001110110001000110110011111011100100000011011000010011111101011110110000101100001000000000000",
                "1101100001110110000111110111100001000000001101011110111100010000000001101100001110111001000000001111011100001000011011101000000000111101101010110110101011011010101101100001000011110110001011110111000010000110111010000000001111111101100001110101111011100001011001110001100001111101000100101111011010001101101010110110101011011000010011010110111001000000110110000100111111010111101100001101000010000001111110101101100001111110110000110111011000101111111110100001011000011111010110110001011011000011101100010001101100110110111001000000110110000100110000000000",
                "1101100001110110000111110111100001000000001101011110111100010000000001101100001110111001000000001111011100001000011011101000000000111101101010110110101011011010101101100001000011110110001111110111000010000110111010000000001111111101100001110101111011100001001101110001100001111101000110101111011001111101101010110110101011011000010011010110111001000000110110000100111111010111101100001101000010000001111110101101100001111110110000111001011000101101111110100001011000101111010110110001011011000011101100010001101100101110111001000000110110000100110000000000",
                "1101100001110110000111110111100001000000001101011110111100010000000001101100001110111001000000001111011100001000011011101000000000111101101010110110101011011010101101100001000011110110010011110111000010000110111010000000001111111101100001110101111011100001000001110001011111111101000111010000111110110011111011010101101101010110110000100110101101110010000001101100001001100001111110101101100001111110110000111011011000101010111110100001011000111111010110110001011011000011101100010001101100100110111001000000110110000100110000000000",
                "11011000011101100001111101111000010000000011010111101111000100000000011011000011101110010000000011110111000010000110111010000000001111011010101101101010110110101011011000010000111101100101111101110000100001101110100000000011111111011000011101011110110110101110001011011111101000111010001011110110011111011010101101101010110110000100110101101110010000001101100001001100001111110101101100001111110110000111101011000100110111110100001011001001111010110110001011011000011101100010001101100011110111001000000110110000100110000000000",
                "11011000011101100001111101111000010000000011010111101111000100000000011011000011101110010000000011110111000010000110111010000000001111011010101101101010110110101011011000010000111101100110111101110000100001101110100000000011111111011000011101011110110101001110001010101111101000111010001111110110011111011010101101101010110110000100110101101110010000001101100001001100001111110101101100001111110110000111111011000100001111110100001011001011111010110110001011011000011101100010001101100010110111001000000110110000100110000000000",
                "11011000011101100001111101111000010000000011010111101111000100000000011011000011101110010000000011110111000010000110111010000000001111011010101101101010110110101011011000010000111101100111111101110000100001101110100000000011111111011000011101011110110011101110001001101111101000111010010011110110011111011010101101101010110110000100110101101110010000001101100001001100001111110101101100001111110110001000001011000011011111110100001011001101111010110110001011011000011101100010001101100001110111001000000110110000100110000000000",
                "1101100001110110000111110111100001000000001101011110111100010000000001101100001110111001000000001111011100001000011011101000000000111101101010110110101011011010101101100001000011110110100011110111000010000110111010000000001111111101100001110101111011001000111000100001111110100011101001011111011001111101101010110110101011011000010011010110111001000000110110000100110000111111010110110000111111011000100000101100001010111110100110011011110101101100010110110000111011000100011010110111001000000110110000100110000000000",
                "1101100001110110000111110111100001000000001101011110111100010000000001101100001110111001000000001111011100001000011011101000000000111101101010110110101011011010101101100001000011110110100111110111000010000110111010000000001111111101100001110101111011000010111000011011111110100011101001101111011001111101101010110110101011011000010011010110111001000000110110000100110000111111010110110000111111011000011111101011111111011000010110011011110101101100010110110000111011000100011010110111001000000110110000100110000000000",
                "1101100001110110000111110111100001000000001101011110111100010000000001101100001110111001000000001111011100001000011011101000000000111101101010110110101011011010101101100001000011110110101011110111000010000110111010000000001111111101100001110101111101000100111000010100111110100011101001111111011001111101101010110110101011011000010011010110111001000000110110000100110000111111010110110000111111011000011101101010011111011000100110011011110101101100010110110000111011000100011010110111001000000110110000100110000000000",
                "110110000111011000101111011110000100000000110101111011110001000000000110110000111011100100000000111101110000100001101110100000000011110110101011011010101101101010110110000100001111011010111111011100001000011011101000000000111111110110000111010111110100101011011001111101000111010100011110101101011010110100011010110111001000000110110000100110000111111010110110000111111011000011010101000111111011000110110011011110101101100010110110000111011000100011010110111001000000110110000100110000000000",
                "1101100001110110000111110111100001000000001101011110111100010000000001101100001110111001000000001111011100001000011011101000000000111101101010110110101011011010101101100001000011110110000111110111000010000110111010000000001111111101100001110101111011100001100001110001100001111101000010101111011010011101101010110110101011011000010011010110111001000000110110000100111111010111101100001101000010000001111110101101100001111110110000110101011000110000111110100001010111101011011000101101100001110110001000110110011111011100100000011011000010011111101011110110000101100001000000000000",
                "1101100001110110000111110111100001000000001101011110111100010000000001101100001110111001000000001111011100001000011011101000000000111101101010110110101011011010101101100001000011110110001011110111000010000110111010000000001111111101100001110101111011100001011001110001100001111101000100101111011010001101101010110110101011011000010011010110111001000000110110000100111111010111101100001101000010000001111110101101100001111110110000110111011000101111111110100001011000011111010110110001011011000011101100010001101100110110111001000000110110000100110000000000",
                "1101100001110110000111110111100001000000001101011110111100010000000001101100001110111001000000001111011100001000011011101000000000111101101010110110101011011010101101100001000011110110001111110111000010000110111010000000001111111101100001110101111011100001001101110001100001111101000110101111011001111101101010110110101011011000010011010110111001000000110110000100111111010111101100001101000010000001111110101101100001111110110000111001011000101101111110100001011000101111010110110001011011000011101100010001101100101110111001000000110110000100110000000000",
                "1101100001110110000111110111100001000000001101011110111100010000000001101100001110111001000000001111011100001000011011101000000000111101101010110110101011011010101101100001000011110110010011110111000010000110111010000000001111111101100001110101111011100001000001110001011111111101000111010000111110110011111011010101101101010110110000100110101101110010000001101100001001100001111110101101100001111110110000111011011000101010111110100001011000111111010110110001011011000011101100010001101100100110111001000000110110000100110000000000",
                "11011000011101100001111101111000010000000011010111101111000100000000011011000011101110010000000011110111000010000110111010000000001111011010101101101010110110101011011000010000111101100101111101110000100001101110100000000011111111011000011101011110110110101110001011011111101000111010001011110110011111011010101101101010110110000100110101101110010000001101100001001100001111110101101100001111110110000111101011000100110111110100001011001001111010110110001011011000011101100010001101100011110111001000000110110000100110000000000",
                "11011000011101100001111101111000010000000011010111101111000100000000011011000011101110010000000011110111000010000110111010000000001111011010101101101010110110101011011000010000111101100110111101110000100001101110100000000011111111011000011101011110110101001110001010101111101000111010001111110110011111011010101101101010110110000100110101101110010000001101100001001100001111110101101100001111110110000111111011000100001111110100001011001011111010110110001011011000011101100010001101100010110111001000000110110000100110000000000",
                "11011000011101100001111101111000010000000011010111101111000100000000011011000011101110010000000011110111000010000110111010000000001111011010101101101010110110101011011000010000111101100111111101110000100001101110100000000011111111011000011101011110110011101110001001101111101000111010010011110110011111011010101101101010110110000100110101101110010000001101100001001100001111110101101100001111110110001000001011000011011111110100001011001101111010110110001011011000011101100010001101100001110111001000000110110000100110000000000",
                "1101100001110110000111110111100001000000001101011110111100010000000001101100001110111001000000001111011100001000011011101000000000111101101010110110101011011010101101100001000011110110100011110111000010000110111010000000001111111101100001110101111011001000111000100001111110100011101001011111011001111101101010110110101011011000010011010110111001000000110110000100110000111111010110110000111111011000100000101100001010111110100110011011110101101100010110110000111011000100011010110111001000000110110000100110000000000",
                "1101100001110110000111110111100001000000001101011110111100010000000001101100001110111001000000001111011100001000011011101000000000111101101010110110101011011010101101100001000011110110100111110111000010000110111010000000001111111101100001110101111011000010111000011011111110100011101001101111011001111101101010110110101011011000010011010110111001000000110110000100110000111111010110110000111111011000011111101011111111011000010110011011110101101100010110110000111011000100011010110111001000000110110000100110000000000",
                "1101100001110110000111110111100001000000001101011110111100010000000001101100001110111001000000001111011100001000011011101000000000111101101010110110101011011010101101100001000011110110101011110111000010000110111010000000001111111101100001110101111101000100111000010100111110100011101001111111011001111101101010110110101011011000010011010110111001000000110110000100110000111111010110110000111111011000011101101010011111011000100110011011110101101100010110110000111011000100011010110111001000000110110000100110000000000",
                "110110000111011000101111011110000100000000110101111011110001000000000110110000111011100100000000111101110000100001101110100000000011110110101011011010101101101010110110000100001111011010111111011100001000011011101000000000111111110110000111010111110100101011011001111101000111010100011110101101011010110100011010110111001000000110110000100110000111111010110110000111111011000011010101000111111011000110110011011110101101100010110110000111011000100011010110111001000000110110000100110000000000");
        for (String serverResponse: serverResponses){
            List<Object> list = DemodulateValue.eval(
                    serverResponse);
//            System.out.println(list.toString());
            GameResponse gameResponse3 = new GameResponse(list);
            System.out.println(gameResponse3.toString());
        }

    }
}
